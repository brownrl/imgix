<?php

module_load_include('inc', 'imgix', 'imgix');

/**
 * Implements hook_menu().
 */
function imgix_menu() {
  $items['admin/config/services/imgix'] = array(
    'title' => t('Imgix Integration'),
    'description' => t('Configuration page to setup Imgix Integration.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('imgix_admin'),
    'access arguments' => array('administer imgix settings'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'imgix.admin.inc'
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function imgix_permission() {
  return array(
    'administer imgix settings' =>  array(
      'title' => t('Administer Imgix Integration settings.'),
      'description' => t('Allow users to setup Imgix Integration.'),
    ),
  );
}

/**
 * Implements hook_theme_registry_alter().
 */
function imgix_theme_registry_alter(&$theme_registry) {
  // Overrides theme_image().
  if (isset($theme_registry['image'])) {
    $theme_registry['image']['function'] = 'imgix_theme_image';
  }
}

/**
 * Overrides theme_image() to return the Imgix URL for images.
 */
function imgix_theme_image($variables) {
  $params = array();

  $attributes = $variables['attributes'];
  $attributes['src'] = file_create_url($variables['path']);

  foreach (array('width', 'height', 'alt', 'title') as $key) {
    if (isset($variables[$key])) {
      $attributes[$key] = $variables[$key];
    }
  }

  // Overrides image URL as Imgix URL.
  if (variable_get('imgix_enable')) {
    if (isset($attributes['width'])) {
      $params['w'] = $attributes['width'];
    }

    if (isset($attributes['height'])) {
      $params['h'] = $attributes['height'];
    }

    $attributes['src'] = imgix_build_url($attributes['src'], $params);
  }

  return '<img' . drupal_attributes($attributes) . ' />';
}
